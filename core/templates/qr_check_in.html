{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QR Check-In - {{ event.event_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', Arial, sans-serif; background: linear-gradient(135deg,#0f1724,#111827); color:#fff; display:flex; align-items:center; justify-content:center; min-height:100vh }
        .card { background:rgba(255,255,255,0.04); padding:1.6rem; border-radius:12px; width:420px; max-width:95%; box-shadow:0 8px 40px rgba(2,6,23,0.6) }
        h2 { color:#ffd966; margin-bottom:0.6rem }
        .muted { color:#cbd5e1; font-size:0.95rem }
        .input-row { display:flex; gap:0.6rem; margin-top:1rem }
        input[type=text] { flex:1; padding:0.7rem 0.9rem; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:#fff }
        button { padding:0.7rem 1rem; border-radius:8px; border:none; background:#ffd966; color:#0b1220; font-weight:600; cursor:pointer }
        .log { margin-top:1rem; background:rgba(0,0,0,0.25); padding:0.8rem; border-radius:8px; font-size:0.95rem; color:#e6eef8; max-height:160px; overflow:auto }
        .back { margin-top:1rem; text-align:right }
    </style>
</head>
<body>
<div class="card">
    <h2>QR Check-In</h2>
    <div class="muted">Event: <strong>{{ event.event_name }}</strong> — Event ID: <strong>{{ event.event_id }}</strong></div>

    <p class="muted" style="margin-top:0.8rem">Scan a QR code (mobile camera) or paste the QR payload below.</p>

    <div class="input-row">
        <input id="payload" type="text" placeholder="Paste QR payload or phone number here">
        <button id="submitBtn">Check In</button>
    </div>
        <div style="margin-top:1rem; display:flex; gap:0.6rem; align-items:center;">
            <button id="startScan" style="background:#06b6d4; color:#021025">Start Camera Scan</button>
            <button id="stopScan" style="background:#ef4444; color:#fff; display:none">Stop Scan</button>
        </div>

        <!-- Scanner container (html5-qrcode) -->
        <div id="reader" style="width:100%; margin-top:0.8rem; display:none"></div>
        <!-- CSRF token for AJAX posts -->
        <input type="hidden" id="csrf_token_input" value="{{ csrf_token }}" />

    <div class="log" id="log">No activity yet.</div>

    <div class="back"><a href="{% url 'event_dashboard' event.event_id %}?role={{ role }}&phone={{ phone }}"><button>Back</button></a></div>
</div>

<script>
const payloadEl = document.getElementById('payload');
const submitBtn = document.getElementById('submitBtn');
const log = document.getElementById('log');
const startScanBtn = document.getElementById('startScan');
const stopScanBtn = document.getElementById('stopScan');
const readerEl = document.getElementById('reader');
const csrfToken = document.getElementById('csrf_token_input').value;

// Load html5-qrcode script dynamically from CDN
function loadScript(src) {
    return new Promise((resolve, reject) => {
        if (document.querySelector('script[src="' + src + '"]')) return resolve();
        const s = document.createElement('script');
        s.src = src;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
    });
}

let html5QrcodeScanner = null;

function appendLog(text) {
    const p = document.createElement('div');
    p.textContent = (new Date()).toLocaleTimeString() + ' — ' + text;
    log.insertBefore(p, log.firstChild);
}

submitBtn.onclick = function() {
    const payload = payloadEl.value.trim();
    if (!payload) { appendLog('No payload entered'); return; }
    appendLog('Parsing payload: ' + payload);

    // send to our QR endpoint which marks attendance
    const form = new FormData();
    form.append('payload', payload);

    fetch(window.location.pathname + '?role={{ role }}&phone={{ phone }}', {
        method: 'POST',
        body: form,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    }).then(r => r.json()).then(data => {
        if (data.success) {
            appendLog('Checked in: ' + data.phone);
            payloadEl.value = '';
        } else {
            appendLog('Error: ' + (data.error || JSON.stringify(data)));
        }
    }).catch(err => {
        appendLog('Request failed: ' + err);
    });
}

// Allow Enter to submit
payloadEl.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { submitBtn.click(); }
});

// Scanner helpers
async function startScanner() {
    try {
            await loadScript('https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js');
        readerEl.style.display = 'block';
        startScanBtn.style.display = 'none';
        stopScanBtn.style.display = '';

            if (!window.Html5Qrcode) {
                appendLog('Scanner failed: Html5Qrcode not found after script load.');
                return;
            }
            html5QrcodeScanner = new window.Html5Qrcode('reader');

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrcodeScanner.start(
                { facingMode: 'environment' },
                config,
                (decodedText, decodedResult) => {
                    appendLog('Scanned: ' + decodedText);
                    payloadEl.value = decodedText;
                    stopScanner();
                },
                (errorMessage) => {
                    // ignore decode errors
                }
            ).catch(err => {
                appendLog('Scanner failed to start: ' + err);
            });
    } catch (err) {
        appendLog('Scanner failed to start: ' + err);
    }
}

async function stopScanner() {
    if (html5QrcodeScanner) {
        try {
            await html5QrcodeScanner.stop();
        } catch (e) {
            console.warn('Error stopping scanner', e);
        }
        html5QrcodeScanner.clear();
        html5QrcodeScanner = null;
    }
    readerEl.style.display = 'none';
    stopScanBtn.style.display = 'none';
    startScanBtn.style.display = '';
}

startScanBtn.addEventListener('click', startScanner);
stopScanBtn.addEventListener('click', stopScanner);

// submit handler shared by manual and scanner
function submitPayload(payload) {
    const form = new FormData();
    form.append('payload', payload);
    // include CSRF token
    form.append('csrfmiddlewaretoken', csrfToken);

    fetch(window.location.pathname + '?role={{ role }}&phone={{ phone }}', {
        method: 'POST',
        body: form,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    }).then(r => r.json()).then(data => {
        if (data.success) {
            appendLog('Checked in: ' + data.phone);
            payloadEl.value = '';
        } else {
            appendLog('Error: ' + (data.error || JSON.stringify(data)));
        }
    }).catch(err => {
        appendLog('Request failed: ' + err);
    });
}

// replace previous direct submit logic to use shared function
submitBtn.onclick = function() {
    const payload = payloadEl.value.trim();
    if (!payload) { appendLog('No payload entered'); return; }
    appendLog('Parsing payload: ' + payload);
    submitPayload(payload);
}
</script>
</body>
</html>
